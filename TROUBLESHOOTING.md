# トラブルシューティングガイド

このドキュメントでは、かんたん清掃報告システムで問題が発生した場合の確認方法と解決策を説明します。

## 目次

1. [ログの確認方法](#ログの確認方法)
2. [よくあるエラーと解決策](#よくあるエラーと解決策)
3. [エラーIDについて](#エラーidについて)

---

## ログの確認方法

### Google Apps Script (GAS) のログ確認

GAS側のエラーログを確認するには:

1. **Google スプレッドシート**を開く
2. メニューから **拡張機能** → **Apps Script** をクリック
3. 左側メニューの **実行数** をクリック
4. 各実行の詳細を展開すると、ログが表示されます

#### ログの読み方

```
[2026-01-08T12:30:45.123Z] [ERROR] [saveReport] Invalid date format | Data: {"errorId":"ERR-ABC123","stack":"..."}
└─ タイムスタンプ ────────┘ └レベル┘ └アクション┘ └─ メッセージ ─────┘  └─ 追加データ ────────────────────┘
```

- **ERROR**: 処理に失敗したエラー
- **WARN**: 警告（処理は継続）
- **INFO**: 正常な処理の記録

---

### ブラウザ DevTools でのエラー確認

ブラウザ側のエラーを確認するには:

1. アプリを開いた状態で **F12** キー（または右クリック → 検証）を押す
2. **Console** タブを選択

#### ログの読み方

```
🔴 [API Error] Action: saveReport
   Error ID: ERR-ABC123
   Message: エラーが発生しました
   Detail: Invalid date format
```

**Error ID** がある場合は、GASのログと照合して詳細を確認できます。

---

## よくあるエラーと解決策

### 1. 「暗証番号が違います」

**原因**: PINが間違っているか、Settingsシートの設定が正しくない

**解決策**:
1. スプレッドシートの **Settings** シートを確認
2. A列に `PIN`、B列に4桁の暗証番号が設定されているか確認
3. PINを変更した場合は、GASを再デプロイ

---

### 2. 「履歴が表示されない」

**原因**: Month列のデータ形式が一致していない可能性

**解決策**:
1. スプレッドシートの **ReportData** シートを確認
2. **J列 (Month)** の値が `yyyy-MM` 形式（例: `2026-01`）か確認
3. 日付型になっている場合は、テキスト形式に変換

---

### 3. 「保存に失敗しました」

**原因**: ネットワークエラー、またはGASのデプロイ設定

**解決策**:
1. インターネット接続を確認
2. GASのデプロイ設定を確認:
   - 次のユーザーとして実行: **自分**
   - アクセスできるユーザー: **全員**
3. 新しいバージョンを再デプロイ

---

### 4. CORSエラー（コンソールに赤いエラー）

**原因**: GASのデプロイ設定が正しくないか、古いURLを使用している

**解決策**:
1. GASを**新しいバージョン**としてデプロイ
2. 発行された新しいURLを `gas_api_client.dart` の `baseUrl` に設定
3. Flutter Webをリビルドして再デプロイ

---

## エラーIDについて

エラーが発生すると、システムは一意の**エラーID**（例: `ERR-ABC123`）を生成します。

### エラーIDの活用

1. **ユーザーへの表示**: エラーメッセージと共にエラーIDが表示されます
2. **ログの照合**: GASの実行ログでエラーIDを検索すると、詳細なスタックトレースを確認できます
3. **サポート問い合わせ**: 問題報告時にエラーIDを共有することで、迅速な原因特定が可能です

---

## デバッグモードの有効化

開発中に詳細なログを有効化するには:

### Flutter側

`gas_api_client.dart` の `get` メソッドにprint文を追加:

```dart
if (response.statusCode == 200) {
  final decoded = jsonDecode(response.body) as Map<String, dynamic>;
  print('✅ API Response: $decoded'); // デバッグ用
  return decoded;
}
```

### GAS側

`Code.js` に一時的なログを追加:

```javascript
function apiGetData(monthStr) {
  Logger.log('🔍 Debug: monthStr = ' + monthStr); // デバッグ用
  // ...
}
```

> **注意**: デバッグ用のログは本番デプロイ前に削除してください。
